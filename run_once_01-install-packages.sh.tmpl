#!/bin/bash
# Install development environment

set -e

echo "üöÄ Setting up development environment..."

{{ if eq .chezmoi.os "darwin" }}
# macOS
if ! command -v git &> /dev/null; then
    xcode-select --install 2>/dev/null || true
fi

# Homebrew (for GUI apps)
if ! command -v brew &> /dev/null; then
    echo "üì¶ Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Ghostty
if ! [ -d "/Applications/Ghostty.app" ]; then
    echo "üì¶ Installing Ghostty..."
    brew install --cask ghostty
fi

# Nerd Fonts
echo "üì¶ Installing Nerd Fonts..."
brew install --cask font-jetbrains-mono-nerd-font
brew install --cask font-fira-code-nerd-font

{{ else if eq .chezmoi.os "linux" }}
# Linux - install system dependencies
if command -v apt &> /dev/null; then
    sudo apt update && sudo apt install -y git curl unzip build-essential
    # Ghostty on Debian/Ubuntu
    if ! command -v ghostty &> /dev/null; then
        echo "üì¶ Installing Ghostty..."
        curl -fsSL https://packagecloud.io/install/repositories/ghostty/release/script.deb.sh | sudo bash
        sudo apt install -y ghostty || echo "‚ö†Ô∏è Ghostty install failed - install manually"
    fi
elif command -v pacman &> /dev/null; then
    sudo pacman -Syu --noconfirm git curl unzip base-devel
    # Ghostty on Arch
    if ! command -v ghostty &> /dev/null; then
        echo "üì¶ Installing Ghostty..."
        sudo pacman -S --noconfirm ghostty || yay -S ghostty || echo "‚ö†Ô∏è Install ghostty via AUR"
    fi
elif command -v dnf &> /dev/null; then
    sudo dnf install -y git curl unzip
    echo "‚ÑπÔ∏è Ghostty: Install from https://ghostty.org"
fi

# Nerd Fonts on Linux
echo "üì¶ Installing Nerd Fonts..."
FONT_DIR="$HOME/.local/share/fonts"
mkdir -p "$FONT_DIR"
if [ ! -f "$FONT_DIR/JetBrainsMonoNerdFont-Regular.ttf" ]; then
    curl -fLo /tmp/JetBrainsMono.zip https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip
    unzip -o /tmp/JetBrainsMono.zip -d "$FONT_DIR"
    fc-cache -fv
fi

{{ else if eq .chezmoi.os "windows" }}
# Windows (via winget/scoop)
echo "üì¶ Installing packages via winget..."
winget install --id Git.Git -e --source winget
winget install --id ghostty.ghostty -e --source winget || echo "‚ö†Ô∏è Install Ghostty manually"

# Nerd Fonts on Windows (via scoop)
if command -v scoop &> /dev/null; then
    scoop bucket add nerd-fonts
    scoop install JetBrainsMono-NF
else
    echo "‚ÑπÔ∏è Install Nerd Fonts manually from https://www.nerdfonts.com"
fi
{{ end }}

# Install mise
echo "üì¶ Installing mise..."
if ! command -v mise &> /dev/null; then
    curl https://mise.run | sh
fi

# Add mise to PATH
export PATH="$HOME/.local/bin:$PATH"
eval "$(~/.local/bin/mise activate bash)"

# Install tools via mise
echo "üì¶ Installing tools via mise..."

# Core tools
mise use --global neovim@latest
mise use --global ripgrep@latest
mise use --global fd@latest
mise use --global fzf@latest
mise use --global lazygit@latest
mise use --global zellij@latest
mise use --global delta@latest
mise use --global bat@latest
mise use --global eza@latest
mise use --global jq@latest
mise use --global gh@latest
mise use --global zoxide@latest

# Language runtimes
mise use --global node@lts
mise use --global python@3.12
mise use --global go@latest
mise use --global rust@latest

echo "‚úÖ All tools installed!"
echo "‚ö†Ô∏è Restart your shell or run: source ~/.zshrc"
